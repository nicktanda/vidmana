<% if @user_prompt && @api_response %>
<div class="overflow-y-auto" id="conversation-scroll" style="height: calc(100vh - 100px);">
  <div class="max-w-3xl mx-auto px-6 py-8">
      <!-- User Message -->
      <div class="flex gap-4 mb-8">
        <div class="flex-shrink-0 w-8 h-8">
          <% if current_user.avatar_url.present? %>
            <img src="<%= current_user.avatar_url %>" alt="<%= current_user.name %>" class="w-8 h-8 rounded-full object-cover">
          <% else %>
            <div class="w-8 h-8 card-bg rounded-full flex items-center justify-center">
              <span class="text-themed text-xs font-medium">
                <%= current_user.name.first.upcase %>
              </span>
            </div>
          <% end %>
        </div>
        <div class="flex-1 pt-1">
          <p class="text-themed"><%= @user_prompt %></p>
        </div>
      </div>

      <!-- Assistant Response -->
      <div class="flex gap-4 mb-8">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-[#10a37f] rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
        </div>
        <div class="flex-1 pt-1 space-y-6">
          <p class="text-themed">
            I've created a universe based on your prompt. Here's what I generated:
          </p>

          <!-- Title Card -->
          <div class="card-bg rounded-2xl p-5 border border-themed">
            <h3 class="text-xl font-semibold text-themed mb-2"><%= @api_response['title'] %></h3>
            <p class="text-themed-secondary text-sm"><%= @api_response['description'] %></p>
          </div>

          <!-- Characters -->
          <% if @api_response['characters'].present? %>
            <div class="card-bg rounded-2xl p-5 border border-themed">
              <h4 class="text-sm font-medium text-themed-muted uppercase tracking-wide mb-4">Characters</h4>
              <div class="space-y-3">
                <% @api_response['characters'].each do |character| %>
                  <div class="flex gap-3">
                    <div class="w-1 bg-[#10a37f] rounded-full flex-shrink-0"></div>
                    <div>
                      <p class="font-medium text-themed"><%= character['name'] %></p>
                      <p class="text-sm text-themed-secondary"><%= character['description'] %></p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Locations -->
          <% if @api_response['locations'].present? %>
            <div class="card-bg rounded-2xl p-5 border border-themed">
              <h4 class="text-sm font-medium text-themed-muted uppercase tracking-wide mb-4">Locations</h4>
              <div class="space-y-3">
                <% @api_response['locations'].each do |location| %>
                  <div class="flex gap-3">
                    <div class="w-1 bg-blue-500 rounded-full flex-shrink-0"></div>
                    <div>
                      <p class="font-medium text-themed"><%= location['name'] %></p>
                      <p class="text-sm text-themed-secondary"><%= location['description'] %></p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Story Structure -->
          <% if @api_response['chapters'].present? %>
            <div class="card-bg rounded-2xl p-5 border border-themed">
              <h4 class="text-sm font-medium text-themed-muted uppercase tracking-wide mb-4">Story Structure</h4>
              <div class="space-y-4">
                <% @api_response['chapters'].each_with_index do |chapter, chapter_index| %>
                  <div>
                    <h5 class="font-medium text-themed mb-2"><%= chapter['name'] %></h5>
                    <% if chapter['description'].present? %>
                      <p class="text-sm text-themed-secondary mb-3"><%= chapter['description'] %></p>
                    <% end %>

                    <% chapter['scenes']&.each do |scene| %>
                      <div class="ml-4 mb-3">
                        <p class="text-sm font-medium text-themed-secondary mb-1"><%= scene['name'] %></p>
                        <% if scene['description'].present? %>
                          <p class="text-sm text-themed-muted mb-2"><%= scene['description'] %></p>
                        <% end %>

                        <% if scene['beats']&.any? %>
                          <div class="ml-4 space-y-2">
                            <% scene['beats'].each_with_index do |beat, beat_index| %>
                              <div class="flex gap-2 text-sm">
                                <span class="text-themed-muted flex-shrink-0"><%= beat_index + 1 %>.</span>
                                <div>
                                  <span class="text-themed-secondary"><%= beat['title'] %></span>
                                  <% if beat['description'].present? %>
                                    <span class="text-themed-muted"> - <%= beat['description'].truncate(150) %></span>
                                  <% end %>
                                </div>
                              </div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Action Buttons -->
          <div class="flex gap-3 pt-2">
            <%= link_to authenticated_root_path, class: "px-4 py-2 text-sm text-themed-secondary card-bg border border-themed rounded-full hover-bg transition-colors" do %>
              New Universe
            <% end %>
            <%= form_with url: universes_path, method: :post, local: true, class: "inline-block" do |form| %>
              <%= form.hidden_field :name, value: @api_response['title'] %>
              <%= form.hidden_field :prompt, value: @api_response['prompt'] %>
              <%= form.hidden_field :full_data, value: @api_response.to_json %>
              <%= form.hidden_field :save_universe, value: true %>
              <%= form.submit "Save Universe", class: "px-4 py-2 text-sm bg-[#10a37f] hover:bg-[#0d8a6b] text-white rounded-full transition-colors cursor-pointer font-medium" %>
            <% end %>
          </div>
        </div>
      </div>
  </div>
</div>

<!-- Fixed input at bottom for conversation mode -->
<div class="fixed bottom-0 right-0 p-4" style="background-color: var(--bg-primary); left: 256px;">
  <div class="max-w-3xl mx-auto">
    <%= render partial: 'universes/prompt_input' %>
  </div>
</div>
<% else %>
  <!-- Empty state: everything centered -->
  <div class="flex-1 flex items-center justify-center px-6">
    <div class="w-full max-w-3xl">
      <!-- Centered greeting -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-semibold text-themed mb-2">What universe will you create?</h1>
        <p class="text-themed-secondary">
          Describe a story concept and I'll generate characters, locations, and a complete narrative structure.
        </p>
      </div>

      <!-- Centered input -->
      <%= render partial: 'universes/prompt_input' %>

      <p class="text-xs text-themed-muted text-center mt-3">
        Vidmana uses AI to generate story structures. Results may vary.
      </p>
    </div>
  </div>
<% end %>

<% if @user_prompt && @api_response %>
<script>
  // Auto-scroll to bottom to show latest response (like a chat app)
  document.addEventListener('DOMContentLoaded', function() {
    const scrollContainer = document.getElementById('conversation-scroll');
    if (scrollContainer) {
      // Start at the top so user sees their message first
      scrollContainer.scrollTop = 0;
    }
  });
</script>
<% end %>
